name: tagged-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  UNITY_LICENSE: "<?xml version=\"1.0\" encoding=\"UTF-8\"?><root>\n    <License id=\"Terms\">\n        <MachineBindings>\n            <Binding Key=\"1\" Value=\"576562626572264761624c65526f7578\"/>\n            <Binding Key=\"2\" Value=\"576562626572264761624c65526f7578\"/>\n        </MachineBindings>\n        <MachineID Value=\"D7nTUnjNAmtsUMcnoyrqkgIbYdM=\"/>\n        <SerialHash Value=\"7d306e7f435cf99fd03218060fe5ee13d95b146f\"/>\n        <Features>\n            <Feature Value=\"33\"/>\n            <Feature Value=\"1\"/>\n            <Feature Value=\"12\"/>\n            <Feature Value=\"2\"/>\n            <Feature Value=\"24\"/>\n            <Feature Value=\"3\"/>\n            <Feature Value=\"36\"/>\n            <Feature Value=\"17\"/>\n            <Feature Value=\"19\"/>\n            <Feature Value=\"62\"/>\n            <Feature Value=\"60\"/>\n        </Features>\n        <DeveloperData Value=\"AQAAAEY0LUVLS0otVFdTUy1OSkZCLTVKTk0tWEpLUw==\"/>\n        <SerialMasked Value=\"F4-EKKJ-TWSS-NJFB-5JNM-XXXX\"/>\n        <StartDate Value=\"2021-06-30T00:00:00\"/>\n        <StopDate Value=\"2021-07-05T04:45:39\"/>\n        <UpdateDate Value=\"2021-07-01T03:45:39\"/>\n        <InitialActivationDate Value=\"2021-06-30T03:45:35\"/>\n        <LicenseVersion Value=\"6.x\"/>\n        <ClientProvidedVersion Value=\"2019.2.11f1\"/>\n        <AlwaysOnline Value=\"false\"/>\n        <Entitlements>\n            <Entitlement Ns=\"unity_editor\" Tag=\"UnityPersonal\" Type=\"EDITOR\" ValidTo=\"9999-12-31T00:00:00\"/>\n            <Entitlement Ns=\"unity_editor\" Tag=\"DarkSkin\" Type=\"EDITOR_FEATURE\" ValidTo=\"9999-12-31T00:00:00\"/>\n        </Entitlements>\n    </License>\n<Signature xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><SignedInfo><CanonicalizationMethod Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments\"/><SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"/><Reference URI=\"#Terms\"><Transforms><Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/></Transforms><DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"/><DigestValue>gN6nAwK6EHkv2sGTJEmS2yYwmKI=</DigestValue></Reference></SignedInfo><SignatureValue>ItiGjv7FqsmXBU/O+sx53uIy00Ee3XCvpQvM+kk9Qj1bTzBMMw2k3WD5RVy7xRjBLX/1fhyzPRhB\n3hZ4YLwjZFoz/Yw+4chIRuauNinSD0kT7YFfbYv4lqzNt8jidR8WJBl1fhGPhoGGiZVIf2//wMsk\nrSrnLwofRtWOB3JzyPvSkXc1ZofO7fB3wQQDyzq9SkgSzwkEMPvmP02bNTcw3D03r3Acjn/r0lh4\nt2zC3jDvy12UsQ2egHPzFu9CCqkr/ZocaPbg9GsN6yC4F7OJVhY8oSxU5oUnYjVYyGerAJ1RrI7m\noCjklwpVSXtJXeJ8fZutiIRt6sFrDgipAVtxyQ==</SignatureValue></Signature></root>"

jobs:
  create_release:
    name: Create release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.draft_release.outputs.upload_url }}
    steps:
      - name: Create release
        id: draft_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}

  buildForAllSupportedPlatforms:
    name: Build for ${{ matrix.targetPlatform }}
    needs: create_release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneWindows64 # Build a Windows 64-bit standalone.
          - StandaloneOSX # Build a macOS standalone (Intel 64-bit).
          - StandaloneLinux64 # Build a Linux 64-bit standalone.
          - Android # Build an Android .apk standalone app.
          - iOS # Build an iOS player.
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          lfs: true
      - uses: actions/cache@v2
        with:
          path: src/Cynthia.Card.Unity/src/Cynthia.Unity.Card/Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: Library-
      - uses: game-ci/unity-builder@main
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: src/Cynthia.Card.Unity/src/Cynthia.Unity.Card
          buildName: DiyGwent-${{ matrix.targetPlatform }}
      - uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_name: DiyGwent-${{ github.ref }}-${{ matrix.targetPlatform }}
          asset_path: build/${{ matrix.targetPlatform }}
          asset_content_type: application/zip
